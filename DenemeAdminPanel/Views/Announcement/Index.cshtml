@model IEnumerable<DenemeAdminPanel.Entities.Announcement>

@{
    ViewData["Title"] = "Duyuru Yönetimi";
}

<div class="row mb-4 align-items-center">
    <div class="col">
        <p class="text-muted small">Duyuruları sürükleyerek sıralayabilir veya düzenleyebilirsiniz.</p>
    </div>
    <div class="col-auto">
        @* Seçilenleri Sil Butonu *@
        <button id="btnBulkDelete" class="btn btn-outline-danger btn-sm me-2 shadow-sm" style="display:none; border-radius: 8px;">
            <i class="bi bi-trash3 me-1"></i> Seçilenleri Sil
        </button>
        <a asp-action="Create" class="btn text-white shadow-sm px-4" style="background-color: var(--ibb-pink); border-radius: 8px;">
            <i class="bi bi-plus-lg me-1"></i> Yeni Duyuru Ekle
        </a>
    </div>
</div>

<div class="card border-0 shadow-sm" style="border-radius: 15px; overflow: hidden;">
    <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
            <thead class="bg-light">
                <tr>
                    <th class="ps-4" style="width: 40px;">
                        <input type="checkbox" id="selectAll" class="form-check-input">
                    </th>
                    <th style="width: 40px;"></th>
                    <th style="width: 100px;">Görsel</th>
                    <th>Başlık</th>
                    <th class="text-center">Sıralama</th>
                    <th>Durum</th>
                    <th class="text-end pe-4">İşlemler</th>
                </tr>
            </thead>
            <tbody id="sortable-body">
                @foreach (var item in Model)
                {
                    <tr data-id="@item.Id" class="sortable-item transition-all">
                        <td class="ps-4">
                            <input type="checkbox" class="select-item form-check-input" value="@item.Id">
                        </td>
                        <td>
                            <i class="bi bi-grip-vertical text-muted fs-5 cursor-move" style="cursor: grab;"></i>
                        </td>
                        <td>
                            <div class="position-relative" style="width: 60px; height: 40px;">
                                <img src="@item.ImageUrl" class="rounded object-fit-cover w-100 h-100 border shadow-sm"
                                     onerror="this.src='/images/no-image.jpg';" alt="Duyuru">
                            </div>
                        </td>
                        <td class="fw-semibold">@item.Title</td>
                        <td class="text-center">
                            <span class="badge bg-light text-dark border display-order px-3 py-2">@item.DisplayOrder</span>
                        </td>
                        <td>
                            <span class="badge-status @(item.IsActive ? "bg-success-subtle text-success" : "bg-secondary-subtle text-secondary")">
                                <i class="bi bi-circle-fill me-1" style="font-size: 0.5rem;"></i>
                                @(item.IsActive ? "Yayında" : "Pasif")
                            </span>
                        </td>
                        <td class="text-end pe-4">
                            <div class="btn-group shadow-sm" style="border-radius: 8px; overflow: hidden;">
                                <a asp-action="Edit" asp-route-id="@item.Id" class="btn btn-white btn-sm border-end" title="Düzenle">
                                    <i class="bi bi-pencil-square text-primary"></i>
                                </a>
                                @* Tekli Silme Butonu *@
                                <a href="javascript:void(0)" onclick="singleDelete(@item.Id)" class="btn btn-white btn-sm" title="Sil">
                                    <i class="bi bi-trash text-danger"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script>
        // --- 1. SÜRÜKLE BIRAK SIRALAMA ---
        const el = document.getElementById('sortable-body');
        new Sortable(el, {
            animation: 150,
            handle: '.bi-grip-vertical',
            ghostClass: 'bg-light',
            onEnd: function() {
                let orderData = [];
                document.querySelectorAll('#sortable-body tr').forEach((row, index) => {
                    orderData.push({
                        Id: parseInt(row.getAttribute('data-id')),
                        NewOrder: index + 1
                    });
                });

                fetch('/Announcement/UpdateOrder', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(orderData)
                }).then(res => {
                    if (res.ok) {
                        document.querySelectorAll('.display-order').forEach((td, i) => td.innerText = i + 1);
                    }
                });
            }
        });

        // --- 2. TEKLİ SİLME FONKSİYONU ---
        function singleDelete(id) {
            if (confirm('Bu duyuruyu silmek istediğinize emin misiniz?')) {
                // Controller'daki Delete metoduna istek gönderiyoruz
                fetch('/Announcement/Delete/' + id, {
                    method: 'POST'
                }).then(res => {
                    if (res.ok) {
                        location.reload(); // Başarılıysa sayfayı yenile
                    } else {
                        alert("Silme işlemi başarısız oldu.");
                    }
                });
            }
        }

        // --- 3. TOPLU SİLME MANTIĞI ---
        const selectAll = document.getElementById('selectAll');
        const bulkBtn = document.getElementById('btnBulkDelete');

        // Hepsini Seç Checkbox'ı
        selectAll.addEventListener('change', () => {
            const items = document.querySelectorAll('.select-item');
            items.forEach(i => i.checked = selectAll.checked);
            toggleBulkButton();
        });

        // Alt Checkbox'lardan biri değiştiğinde "Toplu Sil" butonunu göster/gizle
        document.addEventListener('change', (e) => {
            if (e.target.classList.contains('select-item')) {
                toggleBulkButton();
            }
        });

        function toggleBulkButton() {
            const selectedCount = document.querySelectorAll('.select-item:checked').length;
            bulkBtn.style.display = selectedCount > 0 ? 'inline-block' : 'none';
        }

        // Toplu Silme Butonuna Tıklandığında
        bulkBtn.addEventListener('click', () => {
            if (confirm('Seçilen duyuruları silmek istediğinize emin misiniz?')) {
                const ids = Array.from(document.querySelectorAll('.select-item:checked')).map(i => parseInt(i.value));

                fetch('/Announcement/BulkDelete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(ids)
                }).then(res => {
                    if (res.ok) {
                        location.reload(); // Başarılıysa sayfayı yenile
                    } else {
                        alert("Toplu silme işlemi başarısız oldu.");
                    }
                });
            }
        });
    </script>
}