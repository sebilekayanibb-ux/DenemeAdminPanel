@using DenemeAdminPanel.Controllers
@model List<UserRolesViewModel>

@{
    ViewData["Title"] = "Personel ve Yetki Yönetimi";
}

<div class="container py-4">
    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger shadow-sm border-0 mb-4" style="border-radius: 12px;">
            <i class="fa fa-exclamation-triangle me-2"></i> @TempData["Error"]
        </div>
    }
    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success shadow-sm border-0 mb-4" style="border-radius: 12px;">
            <i class="fa fa-check-circle me-2"></i> @TempData["Success"]
        </div>
    }

    <div class="card border-0 shadow-sm mb-4" style="border-radius: 15px; border-left: 5px solid #E5007D;">
        <div class="card-body p-4">
            <h5 class="fw-bold mb-3"><i class="fa fa-user-plus me-2" style="color: #E5007D;"></i> Yeni Personel Tanımla</h5>
            <form asp-action="CreateUser" method="post" class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label class="small fw-bold text-muted">E-Posta Adresi</label>
                    <input type="email" name="email" class="form-control shadow-sm" placeholder="orn: ad.soyad@ibb.istanbul" required />
                </div>
                <div class="col-md-3">
                    <label class="small fw-bold text-muted">Geçici Şifre</label>
                    <input type="password" name="password" class="form-control shadow-sm" placeholder="******" required />
                </div>
                <div class="col-md-3">
                    <label class="small fw-bold text-muted">Başlangıç Yetkisi</label>
                    <select name="roleName" class="form-select shadow-sm" required>
                        <option value="">Rol Seçiniz...</option>
                        @foreach (var role in ViewBag.AllRoles)
                        {
                            <option value="@role">@role</option>
                        }
                    </select>
                </div>
                <div class="col-md-3">
                    <button type="submit" class="btn text-white w-100 fw-bold" style="background-color: #E5007D; border-radius: 8px; height: 38px;">
                        Personeli Oluştur
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div class="card border-0 shadow-lg" style="border-radius: 20px;">
        <div class="card-header bg-dark text-white p-3 d-flex justify-content-between align-items-center" style="border-radius: 20px 20px 0 0;">
            <h5 class="mb-0"><i class="fa fa-users me-2"></i> Mevcut Personel Listesi</h5>
            <span class="badge bg-secondary">Toplam: @Model.Count</span>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light text-muted small text-uppercase">
                        <tr>
                            <th class="ps-4">Personel</th>
                            <th>Mevcut Yetki</th>
                            <th class="text-center">Yetki Güncelle</th>
                            <th class="text-center">İşlemler</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var user in Model)
                        {
                            <tr>
                                <td class="ps-4">
                                    <div class="d-flex align-items-center">
                                        <div class="rounded-circle bg-light d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px; color: #E5007D;">
                                            <i class="fa fa-user"></i>
                                        </div>
                                        <div>
                                            <div class="fw-bold text-dark">@user.Email</div>
                                            <div class="small text-muted">ID: @user.UserId.Substring(0, 8)...</div>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    @if (user.Roles.Any())
                                    {
                                        <span class="badge px-3 py-2" style="background-color: #E5007D; border-radius: 20px;">
                                            @user.Roles.First()
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-secondary px-3 py-2" style="border-radius: 20px;">Yetkisiz</span>
                                    }
                                </td>
                                <td>
                                    <form asp-action="AssignRole" method="post" class="d-flex gap-2 justify-content-center px-3">
                                        <input type="hidden" name="userId" value="@user.UserId" />
                                        <select name="roleName" class="form-select form-select-sm shadow-sm" style="max-width: 130px;">
                                            <option value="">Değiştir...</option>
                                            @foreach (var role in ViewBag.AllRoles)
                                            {
                                                <option value="@role">@role</option>
                                            }
                                        </select>
                                        <button type="submit" class="btn btn-sm btn-dark" style="border-radius: 6px;">
                                            Onayla
                                        </button>
                                    </form>
                                </td>
                                <td class="text-center">
                                    <div class="d-flex justify-content-center gap-2">
                                        <form asp-action="SendResetEmail" method="post" onsubmit="return confirm('@user.Email adresine şifre sıfırlama maili gönderilecek. Onaylıyor musunuz?')">
                                            <input type="hidden" name="userId" value="@user.UserId" />
                                            <button type="submit" class="btn btn-sm btn-outline-warning" title="Şifre Sıfırlama Maili Gönder">
                                                <i class="fa fa-envelope-open-text"></i>
                                            </button>
                                        </form>

                                        <form asp-action="DeleteUser" method="post" onsubmit="return confirm('@user.Email personeli sistemden tamamen silinecek. Emin misiniz?')">
                                            <input type="hidden" name="userId" value="@user.UserId" />
                                            <button type="submit" class="btn btn-sm btn-outline-danger" title="Sistemden Sil">
                                                <i class="fa fa-trash-alt"></i>
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>